{% extends './base.html' %}
{% block content %}

<div class="w-full h-screen relative">
    <div id="log_message" class="absolute top-0 text-center w-full font-bold text-2xl pt-5   " style="z-index: 1000;">
    </div>
    <div id="map" class="h-full w-full"></div>
    <div id="grid_locations" class="w-full flex flex-wrap items-center gap-5 absolute bottom-0 p-5"
        style="z-index: 1000;"></div>
</div>

<div class="w-1/5 flex items-center justify-center h-full hidden">
    <input id="input_location" type="text" class="input input-bordered" />
</div>

{% endblock %}

{% block javascript %}
<script>
    var inputLocation = $('#input_location');
    var map = null;
    var colors = ["red", "blue", "purple"];
    var polygonLayers = {};


    function onLocationPressed(color, location) {
        let toast = showAlert("Caricamento Strade " + location);
        $.get('/streets?location=' + location).then((result) => {
            if (result.status == 200) {
                polygonLayers[location] = [];
                for (let i in result.streets) {
                    var polygonData = result.streets[i].geometry;
                    const polygonLayer = L.geoJSON(polygonData).addTo(map);
                    polygonLayer.setStyle({ color: color });
                    polygonLayer.addTo(map);
                    polygonLayers[location].push(polygonLayer);
                }
                hideAlert(toast);
            }
        });
    }

    function onRemoveLayer(location) {
        if (location in polygonLayers) {
            for (let i in polygonLayers[location]) {
                map.removeLayer(polygonLayers[location][i]);
            }
            delete polygonLayers[location];
        }
    }

    function buildLocationButton(color, location) {
        var button = $('<div></div>').addClass('btn border-2 border-primary').text(location).on('click', () => {
            if (!button.hasClass('bg-' + color + "-500")) {
                onLocationPressed(color, location);
                button.addClass('bg-' + color + "-500");
            } else {
                onRemoveLayer(location);
                button.removeClass('bg-' + color + "-500");
            }
        });
        $('#grid_locations').append(button);
    }

    function updateMessage(message) {
        $('#log_message').text(message);
    }

    function rertieveAvailableLocations() {
        let toast = showAlert("Recupero delle zone");
        $.get('/locations').then((result) => {
            if (result.status == 200) {
                for (let i in result.locations) {
                    buildLocationButton(colors[i % result.locations.length], result.locations[i]);
                }
            }
            hideAlert(toast);
        });
    }

    function initializeMap() {
        let toast = showAlert("Caricamento Mappa");
        // Crea la mappa
        map = L.map('map').setView([50.814, 4.302], 15);
        // Aggiungi il layer di mappa di base
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Mappa Â© <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
            maxZoom: 18,
            id: 'mapbox.streets',
            subdomains: ['a', 'b', 'c'],
            minZoom: 10,
        }).addTo(map);
       
        hideAlert(toast);
    }

    document.addEventListener('DOMContentLoaded', async () => {
        initializeMap();
        rertieveAvailableLocations();
        $('#input_location').change((e) => {
            retrieveGeometries(e.target.value);
        });
    });

</script>
{% endblock %}